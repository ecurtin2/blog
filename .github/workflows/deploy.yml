name: Deploy

on:
  push:
    branches:
      - master
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Hugo (extended)
        shell: bash
        run: |
          set -euo pipefail
          HUGO_VERSION="0.140.2"
          mkdir -p "$RUNNER_TEMP/hugo"
          curl -L "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz" \
            | tar -xz -C "$RUNNER_TEMP/hugo" hugo
          echo "$RUNNER_TEMP/hugo" >> "$GITHUB_PATH"
          export PATH="$RUNNER_TEMP/hugo:$PATH"
          hugo version

      - name: Install Python dependencies (uv)
        run: uv sync --frozen

      - name: Install Typst
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/typst"
          curl -fsSL https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz \
            | tar -xJ --strip-components=1 -C "$RUNNER_TEMP/typst"
          echo "$RUNNER_TEMP/typst" >> "$GITHUB_PATH"
          typst --version

      - name: Convert notebooks
        run: uv run python convert-notebooks.py

      - name: Build site
        run: hugo --minify

      - name: Build resume (PDF + DOCX)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p resume/build
          typst compile --root . resume/resume.typ resume/build/evan-curtin-resume.pdf
          uv run python resume/generate_docx.py resume/build/evan-curtin-resume.docx

      - name: Upload resume artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: resume
          if-no-files-found: error
          path: |
            resume/build/evan-curtin-resume.pdf
            resume/build/evan-curtin-resume.docx

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy to S3
        run: aws s3 sync public/ s3://evancurtin.com --delete

      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id E4M8LUR5RBKVK --paths "/*"

